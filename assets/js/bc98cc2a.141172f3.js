"use strict";(self.webpackChunkqtaskmachine_doc=self.webpackChunkqtaskmachine_doc||[]).push([[344],{9588:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>s,default:()=>p,frontMatter:()=>o,metadata:()=>a,toc:()=>u});const a=JSON.parse('{"id":"guides/functions/recover","title":"\u72b6\u6001\u6062\u590d","description":"\u4f7f\u7528QHistoryState\u4fdd\u5b58\u5386\u53f2\u72b6\u6001\uff0c\u5386\u53f2\u72b6\u6001\u662f\u7528\u4e8e\u4fdd\u5b58\u4e00\u4e2a\u72b6\u6001\u7ec4\uff0c\u5f53\u4e00\u4e2a\u5b50\u72b6\u6001\u53d1\u751f\u67d0\u79cd\u5f02\u5e38\u5207\u6362\u5230\u4e00\u4e2a\u5355\u72ec\u72b6\u6001\u65f6\uff0c\u4ece\u8fd9\u4e2a\u5355\u72ec\u7684\u72b6\u6001\u518d\u5207\u6362\u5230\u5386\u53f2\u72b6\u6001\u5c06\u91cd\u65b0\u6267\u884c\u4e0a\u4e00\u4e2a\u5b50\u72b6\u6001\u3002\u5386\u53f2\u72b6\u6001\u53ef\u4ee5\u8bbe\u7f6e\u662f\u5426\u4fdd\u5b58\u6240\u6709\u7684\u5d4c\u5957\u5b50\u72b6\u6001\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u53ea\u4f1a\u4fdd\u5b58\u5f53\u524d\u72b6\u6001\u7ec4\u7684\u7b2c\u4e00\u5c42\u6d41\u7a0b\u3002","source":"@site/docs/guides/functions/recover.md","sourceDirName":"guides/functions","slug":"/guides/functions/recover","permalink":"/qtaskmachine/docs/guides/functions/recover","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"sidebar_position":3},"sidebar":"guides","previous":{"title":"\u6761\u4ef6\u72b6\u6001\u5207\u6362","permalink":"/qtaskmachine/docs/guides/functions/condition"},"next":{"title":"\u65e0\u76ee\u6807\u72b6\u6001\u5207\u6362","permalink":"/qtaskmachine/docs/guides/functions/targetless"}}');var i=t(4848),r=t(8453);const o={sidebar_position:3},s="\u72b6\u6001\u6062\u590d",c={},u=[];function d(e){const n={code:"code",h1:"h1",header:"header",p:"p",pre:"pre",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"\u72b6\u6001\u6062\u590d",children:"\u72b6\u6001\u6062\u590d"})}),"\n",(0,i.jsxs)(n.p,{children:["\u4f7f\u7528",(0,i.jsx)(n.code,{children:"QHistoryState"}),"\u4fdd\u5b58\u5386\u53f2\u72b6\u6001\uff0c\u5386\u53f2\u72b6\u6001\u662f\u7528\u4e8e\u4fdd\u5b58\u4e00\u4e2a\u72b6\u6001\u7ec4\uff0c\u5f53\u4e00\u4e2a\u5b50\u72b6\u6001\u53d1\u751f\u67d0\u79cd\u5f02\u5e38\u5207\u6362\u5230\u4e00\u4e2a\u5355\u72ec\u72b6\u6001\u65f6\uff0c\u4ece\u8fd9\u4e2a\u5355\u72ec\u7684\u72b6\u6001\u518d\u5207\u6362\u5230\u5386\u53f2\u72b6\u6001\u5c06\u91cd\u65b0\u6267\u884c\u4e0a\u4e00\u4e2a\u5b50\u72b6\u6001\u3002\u5386\u53f2\u72b6\u6001\u53ef\u4ee5\u8bbe\u7f6e\u662f\u5426\u4fdd\u5b58\u6240\u6709\u7684\u5d4c\u5957\u5b50\u72b6\u6001\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u53ea\u4f1a\u4fdd\u5b58\u5f53\u524d\u72b6\u6001\u7ec4\u7684\u7b2c\u4e00\u5c42\u6d41\u7a0b\u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-cpp",children:'class RecoverEventTrigger : public QObject {\n    Q_OBJECT\n\npublic:\n    using QObject::QObject;\n\nsignals:\n    void trigger();\n    void recoverMain();\n    void recoverChild();\n};\n\nclass RecoverStateRun : public QObject {\npublic:\n    static QStateMachine* run(RecoverEventTrigger* trigger) {\n        auto machine = new QStateMachine;\n\n        //\u72b6\u6001\u5b9a\u4e49\n        auto beginState = new DirectState(machine);\n        beginState->bindState(TaskStateType::State_Enter, machine, [&] {\n            qDebug() << "begin state run...";\n        });\n\n        auto failState = new QState(machine);\n        connect(failState, &QState::entered, machine, [&] {\n            qDebug() << "fail state run...";\n        });\n\n        auto mainGroupState = new EventState(machine);\n        //\u4e3b\u52a8\u89e6\u53d1\u5931\u8d25\uff0c\u4ece\u5b50\u72b6\u6001\u76f4\u63a5\u5207\u6362\u5230\u5931\u8d25\u72b6\u6001\n        connect(trigger, &RecoverEventTrigger::trigger, machine, [=] {\n            mainGroupState->triggerSignalFail();\n        });\n\n        //\u4e3b\u72b6\u6001\u7ec4\u5386\u53f2\u72b6\u6001\n        auto mainGroupHistory = new QHistoryState(mainGroupState);\n\n        //\u5b50\u72b6\u6001\u7ec4\u5386\u53f2\u72b6\u6001\n        auto childGroupHistory = new QHistoryState(QHistoryState::DeepHistory, mainGroupState);\n\n        mainGroupState->bindState(TaskStateType::State_Enter, machine, [&] {\n            qDebug() << "main group state entered...";\n        });\n        mainGroupState->bindState(TaskStateType::State_Exit, machine, [&] {\n            qDebug() << "main group state exited...";\n        });\n\n        {\n            auto s1 = new DirectState(mainGroupState);\n            s1->bindState(TaskStateType::State_Enter, machine, [&] {\n                qDebug() << "group s1 enter...";\n            });\n            //\u8bbe\u7f6e\u5386\u53f2\u9ed8\u8ba4\u72b6\u6001\n            mainGroupHistory->setDefaultState(s1);\n            childGroupHistory->setDefaultState(s1);\n\n            auto s2 = new DelayState(5000, mainGroupState);\n            s2->bindState(TaskStateType::State_Enter, machine, [&] {\n                qDebug() << "group s2 enter...";\n            });\n            s2->bindState(TaskStateType::State_Exit, machine, [&] {\n                qDebug() << "group s2 exited...";\n            });\n\n            auto childGroup = new GroupState(mainGroupState);\n            childGroup->bindState(TaskStateType::State_Enter, machine, [&] {\n                qDebug() << "child group enter...";\n            });\n            childGroup->bindState(TaskStateType::State_Exit, machine, [&] {\n                qDebug() << "child group exited...";\n            });\n\n            {\n                auto s11 = new DirectState(childGroup);\n                s11->bindState(TaskStateType::State_Enter, machine, [&] {\n                    qDebug() << "group s11 enter...";\n                });\n\n                auto s12 = new DelayState(5000, childGroup);\n                s12->bindState(TaskStateType::State_Enter, machine, [&] {\n                    qDebug() << "group s12 enter...";\n                });\n                s12->bindState(TaskStateType::State_Exit, machine, [&] {\n                    qDebug() << "group s12 exited...";\n                });\n\n                auto finalState = new QFinalState(childGroup);\n                connect(finalState, &QState::entered, machine, [&] {\n                    qDebug() << "child group final enter...";\n                });\n\n                //\u72b6\u6001\u5207\u6362\n                *s11 >> s12 >> finalState;\n\n                childGroup->setInitialState(s11);\n            }\n\n            auto finalState = new QFinalState(mainGroupState);\n            connect(finalState, &QState::entered, machine, [&] {\n                qDebug() << "main group final enter...";\n            });\n\n            //\u72b6\u6001\u5207\u6362\n            *s1 >> s2 >> childGroup >> finalState;\n\n            mainGroupState->setInitialState(s1);\n        }\n\n        auto nextState = new DirectState(machine);\n        nextState->bindState(TaskStateType::State_Enter, machine, [&] {\n            qDebug() << "next state enter...";\n        });\n\n        auto finalState = new QFinalState(machine);\n        connect(finalState, &QState::entered, machine, [&] {\n            qDebug() << "final...";\n        });\n\n        //\u72b6\u6001\u5207\u6362\n        mainGroupState->setFailState(failState);\n        failState->addTransition(trigger, &RecoverEventTrigger::recoverMain, mainGroupHistory);\n        failState->addTransition(trigger, &RecoverEventTrigger::recoverChild, childGroupHistory);\n\n        *beginState >> mainGroupState >> nextState >> finalState;\n\n        //\u521d\u59cb\u5316\u5e76\u5f00\u59cb\n        machine->setInitialState(beginState);\n        machine->start();\n\n        return machine;\n    }\n};\n'})}),"\n",(0,i.jsxs)(n.p,{children:["\u4e0a\u9762\u7684\u4f8b\u5b50\u4e2d\uff0c\u5982\u679c\u8fdb\u5165\u5230",(0,i.jsx)(n.code,{children:"s12"}),"\u72b6\u6001\u65f6\uff0c\u89e6\u53d1",(0,i.jsx)(n.code,{children:"mainGroupState"}),"\u7684\u5f02\u5e38\u5206\u652f\uff0c\u5c06\u4ece",(0,i.jsx)(n.code,{children:"s12"}),"\u7acb\u5373\u9000\u51fa\u5230",(0,i.jsx)(n.code,{children:"finalState"}),"\u3002\u5982\u679c\u4ece\u4e3b\u72b6\u6001\u6062\u590d\uff0c\u5219\u91cd\u65b0\u4ece",(0,i.jsx)(n.code,{children:"s11"}),"\u5f00\u59cb\u6267\u884c\uff1a"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-log",children:"[16:09:08.577] -> begin state run...\n[16:09:08.577] -> main group state entered...\n[16:09:08.577] -> group s1 enter...\n[16:09:08.578] -> group s2 enter...\n[16:09:13.572] -> group s2 exited...\n[16:09:13.573] -> child group enter...\n[16:09:13.574] -> group s11 enter...\n[16:09:13.575] -> group s12 enter...\n[16:09:14.252] -> group s12 exited...\n[16:09:14.252] -> child group exited...\n[16:09:14.253] -> main group state exited...\n[16:09:14.253] -> fail state run...\n[16:09:16.876] -> main group state entered...\n[16:09:16.876] -> child group enter...\n[16:09:16.877] -> group s11 enter...\n[16:09:16.877] -> group s12 enter...\n[16:09:21.871] -> group s12 exited...\n[16:09:21.872] -> child group final enter...\n[16:09:21.873] -> child group exited...\n[16:09:21.873] -> main group final enter...\n[16:09:21.874] -> main group state exited...\n[16:09:21.874] -> next state enter...\n[16:09:21.875] -> final...\n"})}),"\n",(0,i.jsxs)(n.p,{children:["\u800c\u5982\u679c\u4ece\u5b50\u72b6\u6001\u6062\u590d\uff0c\u5219\u91cd\u65b0\u4ece",(0,i.jsx)(n.code,{children:"s12"}),"\u5904\u5f00\u59cb\u6267\u884c\uff1a"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-log",children:"[16:10:35.253] -> begin state run...\n[16:10:35.253] -> main group state entered...\n[16:10:35.253] -> group s1 enter...\n[16:10:35.254] -> group s2 enter...\n[16:10:40.245] -> group s2 exited...\n[16:10:40.247] -> child group enter...\n[16:10:40.247] -> group s11 enter...\n[16:10:40.248] -> group s12 enter...\n[16:10:41.831] -> group s12 exited...\n[16:10:41.832] -> child group exited...\n[16:10:41.832] -> main group state exited...\n[16:10:41.833] -> fail state run...\n[16:10:43.748] -> main group state entered...\n[16:10:43.748] -> child group enter...\n[16:10:43.748] -> group s12 enter...\n[16:10:48.744] -> group s12 exited...\n[16:10:48.745] -> child group final enter...\n[16:10:48.745] -> child group exited...\n[16:10:48.745] -> main group final enter...\n[16:10:48.746] -> main group state exited...\n[16:10:48.746] -> next state enter...\n[16:10:48.747] -> final...\n"})})]})}function p(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>s});var a=t(6540);const i={},r=a.createContext(i);function o(e){const n=a.useContext(r);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),a.createElement(r.Provider,{value:n},e.children)}}}]);